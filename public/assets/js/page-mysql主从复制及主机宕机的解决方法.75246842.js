(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{514:function(s,a,t){"use strict";t.r(a);var e=t(2),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"mysql主从复制及主机宕机的解决方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从复制及主机宕机的解决方法"}},[s._v("#")]),s._v(" mysql主从复制及主机宕机的解决方法")]),s._v(" "),t("p",[s._v("本篇博客仅为学习笔记。")]),s._v(" "),t("h3",{attrs:{id:"概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),t("p",[s._v("​\t\tMySQL主从复制是其最重要的功能之一。主从复制是指一台服务器充当主数据库服务器，另一台或多台服务器充当从数据库服务器，主服务器中的数据自动复制到从服务器之中。对于多级复制，数据库服务器即可充当主机，也可充当从机。MySQL主从复制的基础是主服务器对数据库修改记录二进制日志，从服务器通过主服务器的二进制日志自动执行更新。")]),s._v(" "),t("h3",{attrs:{id:"binlog和relaylog的作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#binlog和relaylog的作用"}},[s._v("#")]),s._v(" binlog和relaylog的作用")]),s._v(" "),t("blockquote",[t("p",[s._v("binlog的主要作用是记录数据库中表的更改，它只记录改变数据的sql，不改变数据的sql不会写入，比如select语句一般不会被记录，因为他们不会对数据产生任何改动。")]),s._v(" "),t("p",[s._v("relay log中（中继日志）中，中继日志也是记录日志更新的信息的")])]),s._v(" "),t("h3",{attrs:{id:"为什么需要主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要主从复制"}},[s._v("#")]),s._v(" 为什么需要主从复制")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("提高数据库读写性能，提升系统吞吐量")]),s._v(" "),t("p",[s._v("​\t\t在业务复杂的系统中，如果有一条 SQL 语句的执行需要锁表，导致 MySQL 暂时不能提供读的服务，那么就很影响运行中的业务，使用主从复制，让主库负责写，从库负责读，这样即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运作。")]),s._v(" "),t("p",[s._v("​\t\t这样读写分离的过程能够是整体的服务性能提高，即使写操作时间比较长，也不影响读操作的进行。")])])]),s._v(" "),t("h3",{attrs:{id:"主从复制原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从复制原理"}},[s._v("#")]),s._v(" 主从复制原理")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://res-static.hc-cdn.cn/fms/img/e5e05b7b5cfd963c94c23a970564041f1603768896154",alt:"小白都能懂的Mysql主从复制原理（原理+实操）3"}})]),s._v(" "),t("p",[s._v("Mysql的主从复制中主要有三个线程："),t("code",[s._v("binlog dump thread、slave的I/O thread 、SQL thread）")]),s._v("。")]),s._v(" "),t("blockquote",[t("p",[s._v("当Master有数据更新的时候，会按照binlog 的格式，将更新的事件类型写入master的binlog文件中，创建binlog dump thread通知slave说master库中有数据更新，此时slave接收到通知之后，会创建I/O thread来请求master，master会返回binlog文件的副本以及数据更新的位置，slave收到binlog副本文件后，将文件保存在relay log中（中继日志）中，中继日志也是记录日志更新的信息的，随后sql thread在slave中创建，将更新的内容同步到slave数据库中，这样就保证了主从的数据同步。")])]),s._v(" "),t("p",[s._v("以上就是主从复制的过程，当然，主从复制的过程有不同的策略方式进行数据的同步，主要包含以下几种：")]),s._v(" "),t("p",[s._v("同步策略：Master会等待所有的slave都回应后才会提交，这会使主从同步的性能严重的影响")]),s._v(" "),t("p",[s._v("半同步策略：Master至少会等待一个slave回应后在提交")]),s._v(" "),t("p",[s._v("异步策略：Master不用等待slave回应就可以提交")]),s._v(" "),t("p",[s._v("延迟策略：slave要落后Master指定的时间")]),s._v(" "),t("h3",{attrs:{id:"主从搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从搭建"}},[s._v("#")]),s._v(" 主从搭建")]),s._v(" "),t("h4",{attrs:{id:"删除mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#删除mysql"}},[s._v("#")]),s._v(" 删除mysql")]),s._v(" "),t("p",[s._v("这里提供centos7下完全卸载MySQL的方法")]),s._v(" "),t("blockquote",[t("p",[s._v("首先检查centos 7里面的Mysql安装包和依赖包：")])]),s._v(" "),t("blockquote",[t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -qa "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" mysql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接着可以删除上面的安装包和依赖包：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" yum remove mysql*\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("继续检查一下是否存在Mariadb，若是存在直接删除Mariadb")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("// 检查是否存在Mariadb\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -qa "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" mariadb\n// 删除Mariadb\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -e --nodeps mariadb-libs-xxxxx.el7.x86_64\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("然后，就是删除Mysql的配置文件，可以使用下面的命令查找Msqyl配置文件的路径：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" / -name mysql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后，通过下面的命令，将他们逐一删除：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /usr/lib64/mysql\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("接着就开始安装Mysql 8了，使用wget命令下载Mysql 8的repo源，并且执行安装：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.mysql.com//mysql80-community-release-el7-3.noarch.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" yum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mysql80-community-release-el7-3.noarch.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])]),s._v(" "),t("blockquote",[t("p",[s._v("安装完后会在/etc/yum.repos.d/目录下生成下面的两个文件，说明安装成功了：")]),s._v(" "),t("p",[s._v("mysql-community.repo\nmysql-community-source.repo")]),s._v(" "),t("p",[s._v("安装完Mysql8后，接着来更新一下yum源，并且查看yum仓库中的Mysql：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("// 更新yum源\nyum clean all\nyum makecache\n// 查看yum仓库中的Mysql\nyum list "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" mysql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("可以查看到仓库中存在mysql-community-server.x86_64，直接安装就行了：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("sudo yum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("y install mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("community"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接着启动Mysql，并检查Mysql的状态：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 启动Mysql")]),s._v("\nsystemctl start  mysqld"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 检查Mysql的状态")]),s._v("\nsystemctl status mysqld\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/weixin_43640848/article/details/113064552?spm=1001.2014.3001.5501",target:"_blank",rel:"noopener noreferrer"}},[s._v("修改密码参考此链接的博客"),t("OutboundLink")],1)]),s._v(" "),t("h4",{attrs:{id:"开始搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开始搭建"}},[s._v("#")]),s._v(" 开始搭建")]),s._v(" "),t("p",[s._v("这里使用的使用两台centos 7的vmware的ip分别是"),t("code",[s._v("192.168.163.155（Slave）")]),s._v("和"),t("code",[s._v("192.168.163.156（Master）")]),s._v("作为测试，首先在192.168.163.156（Master）中创建一个测试库test：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建测试库")]),s._v("\ncreate database test "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" character "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4 collate utf8mb4_general_ci"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 并且授权")]),s._v("\ngrant all privileges on test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" to "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),s._v("@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("然后编辑Master中的my.cnf文件，此文件位于/etc/my.cnf，执行下面的sql，并添加下面的信息：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("sudo vi "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("my"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cnf\n\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("以下是配置文件中的信息"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n# 配置编码为utf8\ncharacter_set_server"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4\ninit_connect"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'SET NAMES utf8mb4'")]),s._v("\n\n# 配置要给Slave同步的数据库\nbinlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("test\n# 不用给Slave同步的数据库，一般是Mysql自带的数据库就不用给Slave同步了\nbinlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ignore"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql\nbinlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ignore"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("information_schema\nbinlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ignore"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("performance_schema\nbinlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ignore"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("db"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sys\n# 自动清理"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("天前的log文件\nexpire_logs_days"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n# 启用二进制日志\nlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin\n# Master的id，这个要唯一，唯一是值，在主从中唯一\nserver"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("配置完后重启Mysql服务，并查看Mysql的log_bin日志是否启动成功：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("systemctl restart mysqld\n# 查看log_bin日志是否启动成功\nshow variables like "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%log_bin%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://res-static.hc-cdn.cn/fms/img/e4f43074b2ac347b63eb72413cc238d51603768896155",alt:"小白都能懂的Mysql主从复制原理（原理+实操）10"}})]),s._v(" "),t("p",[s._v("接着查看Master的状态：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("show master status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://res-static.hc-cdn.cn/fms/img/378a21cfaace770d4c2612f488e286d11603768896155",alt:"小白都能懂的Mysql主从复制原理（原理+实操）11"}})]),s._v(" "),t("p",[s._v("这两个数据"),t("code",[s._v("File")]),s._v("和"),t("code",[s._v("Position")]),s._v("要记住，后面配置Slave的时候要使用到这两个数据。")]),s._v(" "),t("p",[s._v("最后登陆Master的数据库，并创建一个用户用于同步数据：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("create user "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),s._v("@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("IDENTIFIED")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'LDCldc-2020'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ngrant file on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" to "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),s._v("@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("REPLICATION")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SLAVE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("REPLICATION")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CLIENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" to "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),s._v("@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("到这里Master的配置就配置完了，后面就进行Slave的配置。")]),s._v(" "),t("p",[s._v("在Slave中同样要创建test数据库，并且授权给test用户")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("# 创建同步数据的test数据库\ncreate database test "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" character "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" utf8mb4 collate utf8mb4_general_ci"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n# 授权\ngrant all privileges on test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" to "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),s._v("@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("接着编辑Slave中my.cnf文件，同样是在/etc/my.cnf路径下，加入如下配置：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("# 配置从服务器的"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("，唯一的\nserver"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n#加上以下参数可以避免更新不及时，"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SLAVE")]),s._v(" 重启后导致的主从复制出错。\nread_only "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nmaster_info_repository"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("TABLE")]),s._v("\nrelay_log_info_repository"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("TABLE")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("并且重启Slave中的Mysql服务：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("systemctl restart mysqld\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在Slave中添加Master的信息：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("# master_host是Master的ip，master_log_file和master_log_pos就是配置之前查看Master状态时显示的File和Position信息\nchange master to master_host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.163.156'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'LDCldc-2020'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_log_file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000001'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_log_pos"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1513")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("最后查看Slave的状态：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("show slave status\\"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("G")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://res-static.hc-cdn.cn/fms/img/33e958b62244225ced7111c1dfd6d72b1603768896156",alt:"小白都能懂的Mysql主从复制原理（原理+实操）12"}})]),s._v(" "),t("p",[s._v("当看到"),t("code",[s._v("Slave_IO_Running")]),s._v("和"),t("code",[s._v("Slave_SQL_Running")]),s._v("都是yes的时候，这表示主从配置成功。")]),s._v(" "),t("p",[t("strong",[s._v("「Slave_IO_Running也就是Slave中的IO线程用于请求Master，Slave_SQL_Running时sql线程将中继日志中更新日志同步到Slave数据库中。」")])]),s._v(" "),t("p",[s._v("但是，有时候Slave_IO_Running会为no，而Slave_SQL_Running为yes")]),s._v(" "),t("p",[s._v("首先看重启一下"),t("code",[s._v("Slave")]),s._v("的MySQL服务："),t("code",[s._v("systemctl restart mysqld")]),s._v("，然后执行：")]),s._v(" "),t("div",{staticClass:"language-javascript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[s._v("stop slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nstart slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("这样就能够使"),t("code",[s._v("Slave_IO_Running")]),s._v("和"),t("code",[s._v("Slave_SQL_Running")]),s._v("显示都是yes了")]),s._v(" "),t("h3",{attrs:{id:"mysql主机宕机的解决方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql主机宕机的解决方法"}},[s._v("#")]),s._v(" Mysql主机宕机的解决方法")]),s._v(" "),t("p",[s._v("​\t\t假设我们有三个机子")]),s._v(" "),t("p",[s._v("master： 192.168.80.130")]),s._v(" "),t("p",[s._v("slave：192.168.80.143")]),s._v(" "),t("p",[s._v("slave：192.168.80.146")]),s._v(" "),t("p",[s._v("​\t\t首先模拟（MySQL---master）宕机：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" mysqld stop\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("​\t\t当master宕机后去slave去查看是否出现错误信息")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("show slave status\\G;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://blog-1300924781.cos.ap-guangzhou.myqcloud.com/blog/3d02e4e4a3fa4fcb34cbe8d78f59731df1e.png",alt:"img"}})]),s._v(" "),t("p",[s._v("​\t\t这时两台SLAVE主机已经连接不上MASTER")]),s._v(" "),t("p",[s._v("​\t\tIO进程和sql进程状态：Slave_IO_Running: Connecting(该状态表示会一直尝试重连主，如果主正常了，该进程状态会自动变成Yes)，此时，master不能提供读写服务。我们想将其中最新的slave提升为主。")]),s._v(" "),t("p",[s._v("​\t\t具体操作步骤如下：")]),s._v(" "),t("p",[s._v("1、在每个SLAVE库上执行：")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("stop  slave io_thread;\n\nshow  processlist;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("直到看到Slave has read all relay log; waitingfor more updates,则表示从库更新都执行完毕了")]),s._v(" "),t("p",[s._v("2、 选择新的主库")]),s._v(" "),t("p",[s._v("​\t\t对比选择Relay_Master_Log_File,Exec_Master_Log_Pos最大的作为新的主库，这里我们选择slave1为新的主库")]),s._v(" "),t("p",[s._v("​\t\t其实，如果两个从IO进程一直都是正常，没有落后于主，且relay log都已经重放完成，两个从是一样的，选择哪个都可以。")]),s._v(" "),t("p",[s._v("​\t\t这里选择slave1作为新主。")]),s._v(" "),t("p",[s._v("3、进行相应配置")]),s._v(" "),t("p",[s._v("​\t\t登陆slave1，执行stop slave;并进入数据库目录，删除master.info和relay-log.info文件（删除前，可以先备份下这俩文件）；")]),s._v(" "),t("p",[s._v("​\t\t配置my.cnf文件，开启log-bin,如果有log-slaves-updates=1和read-only=1则要注释掉，然后重启slave1.")]),s._v(" "),t("p",[s._v("4、 reset master")]),s._v(" "),t("blockquote",[t("p",[s._v("在slave1上reset master，会重新生成二进制日志。")]),s._v(" "),t("p",[s._v("mysql> reset master;")]),s._v(" "),t("p",[s._v("Query OK, 0 rows affected (0.02 sec)")]),s._v(" "),t("p",[s._v("mysql> show master status;\n+------------------+----------+--------------+------------------+\n| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |\n+------------------+----------+--------------+------------------+\n| mysql-log.000001 | 399 |        |            |\n+------------------+----------+--------------+------------------+\n1 row in set (0.00 sec)")])]),s._v(" "),t("p",[s._v("5、创建用于同步的用户")]),s._v(" "),t("p",[s._v("如果slave1完全同步master的话，这步可以省略。")]),s._v(" "),t("p",[s._v("6、 slave2指向slave1")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql>change master to master_user='RepUser',master_password='beijing',master_host='192.168.80.134',master_port=3306,master_log_file='mysql-bin.000001',master_log_pos=154;\n\nmysql>start slave;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);