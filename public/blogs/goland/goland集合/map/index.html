<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>map | clsld &#39;s codebook</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="clsld &#39;s 的个人博客">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/assets/css/0.styles.cbe5bae5.css" as="style"><link rel="preload" href="/assets/js/app.21284b8f.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Layout.cb79b8cd.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.7be66c78.js" as="script"><link rel="preload" href="/assets/js/page-map.41dbe3e8.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout.9ce9a2be.js" as="script"><link rel="prefetch" href="/assets/js/66.1666922c.js"><link rel="prefetch" href="/assets/js/67.318a6c12.js"><link rel="prefetch" href="/assets/js/layout-Blog.68b41fe1.js"><link rel="prefetch" href="/assets/js/layout-Layout.f3e9cb51.js"><link rel="prefetch" href="/assets/js/layout-NotFound.4f4e0f56.js"><link rel="prefetch" href="/assets/js/layout-Slide.9bc3a124.js"><link rel="prefetch" href="/assets/js/page--24251f30.8f55252e.js"><link rel="prefetch" href="/assets/js/page--779ab921.20a0ad56.js"><link rel="prefetch" href="/assets/js/page-CSRF与跨域.5a0c277c.js"><link rel="prefetch" href="/assets/js/page-Flamingo年终总结.fa80a37d.js"><link rel="prefetch" href="/assets/js/page-GiteePage自动更新脚本.4ade3f57.js"><link rel="prefetch" href="/assets/js/page-GoRuntime.c6f79171.js"><link rel="prefetch" href="/assets/js/page-Hbase.3eaab2a8.js"><link rel="prefetch" href="/assets/js/page-LSM.c29d1390.js"><link rel="prefetch" href="/assets/js/page-MapReduce.da5da89b.js"><link rel="prefetch" href="/assets/js/page-Mysql复习.7309d86e.js"><link rel="prefetch" href="/assets/js/page-Redis复习.89e9f88b.js"><link rel="prefetch" href="/assets/js/page-Tidb.4a85db59.js"><link rel="prefetch" href="/assets/js/page-Todo.73adde4e.js"><link rel="prefetch" href="/assets/js/page-atomic.b4a6caf0.js"><link rel="prefetch" href="/assets/js/page-centos7下安装docker.37f26d5d.js"><link rel="prefetch" href="/assets/js/page-centos下mysql的安装和配置远程.029e8187.js"><link rel="prefetch" href="/assets/js/page-channel.0032ef7d.js"><link rel="prefetch" href="/assets/js/page-context.b2642f51.js"><link rel="prefetch" href="/assets/js/page-cpuload比较高，怎么排查？.22045cd8.js"><link rel="prefetch" href="/assets/js/page-docker的jar包快速部署运行.3627de0e.js"><link rel="prefetch" href="/assets/js/page-goland基础.1a96643e.js"><link rel="prefetch" href="/assets/js/page-gotest.2d61729e.js"><link rel="prefetch" href="/assets/js/page-go服务限流熔断.3c28443b.js"><link rel="prefetch" href="/assets/js/page-go简单优化笔记.dcb233d0.js"><link rel="prefetch" href="/assets/js/page-interface原理.8f0acf78.js"><link rel="prefetch" href="/assets/js/page-istio学习.a8b7c0e3.js"><link rel="prefetch" href="/assets/js/page-k8sPrometheus组件.c0ac3c62.js"><link rel="prefetch" href="/assets/js/page-kafka相关问题.3c002831.js"><link rel="prefetch" href="/assets/js/page-mysql主从复制及主机宕机的解决方法.12282682.js"><link rel="prefetch" href="/assets/js/page-mysql执行优化.c0d42a25.js"><link rel="prefetch" href="/assets/js/page-promethues.462f34c1.js"><link rel="prefetch" href="/assets/js/page-redis的安装和远程连接配置.61a446c1.js"><link rel="prefetch" href="/assets/js/page-select、poll、epoll.d280b95a.js"><link rel="prefetch" href="/assets/js/page-slice.f25c03b7.js"><link rel="prefetch" href="/assets/js/page-superGolang.b8e2c4ed.js"><link rel="prefetch" href="/assets/js/page-superUilts.a7a97184.js"><link rel="prefetch" href="/assets/js/page-superjava.76417494.js"><link rel="prefetch" href="/assets/js/page-syncMutex和symcRWMutex.268ef02c.js"><link rel="prefetch" href="/assets/js/page-syncPool.709f5252.js"><link rel="prefetch" href="/assets/js/page-什么逃逸分析.7c0051a3.js"><link rel="prefetch" href="/assets/js/page-元数据管理.791ae27e.js"><link rel="prefetch" href="/assets/js/page-分布式一致性算法.180f8f6b.js"><link rel="prefetch" href="/assets/js/page-剑指offter刷题笔记.5216b186.js"><link rel="prefetch" href="/assets/js/page-剧本大纲.1fcbdbb5.js"><link rel="prefetch" href="/assets/js/page-协作调度和抢占式调度.c7d86451.js"><link rel="prefetch" href="/assets/js/page-大量数据处理问题.9f9dd32d.js"><link rel="prefetch" href="/assets/js/page-应聘简历：陈霖（chenlin）.6981ff1b.js"><link rel="prefetch" href="/assets/js/page-微服务动态上线下.0deccf0f.js"><link rel="prefetch" href="/assets/js/page-核心组件.962d94d0.js"><link rel="prefetch" href="/assets/js/page-生产中git的使用.ecbe30fb.js"><link rel="prefetch" href="/assets/js/page-缓存的问题以及双写不一致分析.03ea793d.js"><link rel="prefetch" href="/assets/js/page-虚拟内存.576b92ae.js"><link rel="prefetch" href="/assets/js/page-计算机与网络.f49fe096.js"><link rel="prefetch" href="/assets/js/page-读写锁和互斥锁的区别.c30a6a0b.js"><link rel="prefetch" href="/assets/js/page-零拷贝.ce98c008.js"><link rel="prefetch" href="/assets/js/vendors~photo-swipe.fd790ed5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cbe5bae5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">clsld 's codebook</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link router-link-active"><i class="iconfont icon-reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont icon-reco-date"></i>
  TimeLine
</a></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/" class="nav-link router-link-active"><i class="iconfont icon-reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont icon-reco-date"></i>
  TimeLine
</a></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable open"><!----> <span class="title">Blogs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/me/" class="sidebar-link">## 应聘简历：陈霖（chenlin）</a></li><li><a href="/blogs/todo/" class="sidebar-link">Todo</a></li><li><a href="/blogs/%E5%89%A7%E6%9C%AC%E5%A4%A7%E7%BA%B2/" class="sidebar-link">剧本大纲</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable open"><!----> <span class="title">Goland</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/goland/gin/gin/" class="sidebar-link">/blogs/goland/gin/gin/</a></li><li><a href="/blogs/goland/go%20prometheus/" class="sidebar-link">promethues</a></li><li><a href="/blogs/goland/go_test/" class="sidebar-link">go test</a></li><li><a href="/blogs/goland/goland%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/GoRuntime/" class="sidebar-link">GoRuntime</a></li><li><a href="/blogs/goland/goland%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/" class="sidebar-link">什么逃逸分析</a></li><li><a href="/blogs/goland/goland%E5%9F%BA%E7%A1%80/" class="sidebar-link">goland基础</a></li><li><a href="/blogs/goland/goland%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="sidebar-link">读写锁和互斥锁的区别</a></li><li><a href="/blogs/goland/goland%E9%94%81/sync.Mutex%20and%20sync.RWMutex/" class="sidebar-link">sync.Mutex和symc.RWMutex</a></li><li><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/atomic/" class="sidebar-link">atomic</a></li><li><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/channel/" class="sidebar-link">channel</a></li><li><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/context/" class="sidebar-link">context</a></li><li><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/" aria-current="page" class="active sidebar-link">map</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map" class="sidebar-link">map</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的用法" class="sidebar-link heading3">map的用法</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的底层结构" class="sidebar-link heading3">map的底层结构</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的创建" class="sidebar-link heading3">map的创建</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的访问" class="sidebar-link heading3">map的访问</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#get拿取数据" class="sidebar-link heading3">GET拿取数据</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的赋值" class="sidebar-link heading3">map的赋值</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的扩容" class="sidebar-link heading3">map的扩容</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的删除" class="sidebar-link heading3">map的删除</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的迭代" class="sidebar-link heading3">map的迭代</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#注意事项" class="sidebar-link heading3">注意事项</a></li></ul></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#sync-map" class="sidebar-link">sync.map</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#如何使用" class="sidebar-link heading3">如何使用</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map数据结构" class="sidebar-link heading3">Map数据结构</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#查找过程" class="sidebar-link heading3">查找过程：</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#写入过程" class="sidebar-link heading3">写入过程：</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#删除过程" class="sidebar-link heading3">删除过程：</a></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#分段锁实现" class="sidebar-link heading3">分段锁实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map实现set" class="sidebar-link">map实现set</a></li></ul></li><li><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/slice/" class="sidebar-link">slice</a></li><li><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/sync.Pool/" class="sidebar-link">sync.Pool</a></li><li><a href="/blogs/goland/go%E7%AE%80%E5%8D%95%E4%BC%98%E5%8C%96%E7%AC%94%E8%AE%B0/" class="sidebar-link">go简单优化笔记</a></li><li><a href="/blogs/goland/go%E9%99%90%E6%B5%81%E7%86%94%E6%96%AD/" class="sidebar-link">go服务限流熔断</a></li><li><a href="/blogs/goland/interface%E5%8E%9F%E7%90%86/" class="sidebar-link">interface原理</a></li><li><a href="/blogs/goland/%E6%8A%A2%E5%8D%A0%E5%BC%8F%E8%B0%83%E5%BA%A6/" class="sidebar-link">协作调度和抢占式调度</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">K 8 S</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">计划学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">面试</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">map</span></h1> <div class="page-info"><!----> <!----><span aria-label="Page views🔢" data-balloon-pos="down" defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 0 0-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/blogs/goland/goland%E9%9B%86%E5%90%88/map/" data-flag-title="map" class="leancloud_visitors waline-visitor-count"><span class="leancloud-visitors-count">...</span></span></span><span aria-label="Writing Date📅" data-balloon-pos="down" defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2023-1-31</span></span><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 16 min</span> <meta property="timeRequired" content="PT16M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map" class="anchor-link heading2"><div>map</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的用法" class="anchor-link heading3"><div>map的用法</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的底层结构" class="anchor-link heading3"><div>map的底层结构</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的创建" class="anchor-link heading3"><div>map的创建</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的访问" class="anchor-link heading3"><div>map的访问</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#get拿取数据" class="anchor-link heading3"><div>GET拿取数据</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的赋值" class="anchor-link heading3"><div>map的赋值</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的扩容" class="anchor-link heading3"><div>map的扩容</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的删除" class="anchor-link heading3"><div>map的删除</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map的迭代" class="anchor-link heading3"><div>map的迭代</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#注意事项" class="anchor-link heading3"><div>注意事项</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#sync-map" class="anchor-link heading2"><div>sync.map</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#如何使用" class="anchor-link heading3"><div>如何使用</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map数据结构" class="anchor-link heading3"><div>Map数据结构</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#查找过程" class="anchor-link heading3"><div>查找过程：</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#写入过程" class="anchor-link heading3"><div>写入过程：</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#删除过程" class="anchor-link heading3"><div>删除过程：</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#分段锁实现" class="anchor-link heading3"><div>分段锁实现</div></a></li><li class="anchor"><a href="/blogs/goland/goland%E9%9B%86%E5%90%88/map/#map实现set" class="anchor-link heading2"><div>map实现set</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h2 id="map"><a href="#map" class="header-anchor">#</a> map</h2> <p>常见的hash冲突解决方法</p> <blockquote><p>hash查找表用一个hash将key分配到不同的桶bucket，也就是数组不同的index，hash查找表一般会存在碰撞问题，就是说不同的key被hash到同一个bucket，一般有三种方法，链表法、开放地址法和搜索树法，链表法将一个bucket实现成一个链表，落在同一个bucket中的key都会插入这个链表。开放地址法是发生碰撞后，通过一定的规律，在数组后面挑选空位来放置新的key。搜索树是在碰撞节点建立类似avl树、红黑树(java)等</p></blockquote> <h3 id="map的用法"><a href="#map的用法" class="header-anchor">#</a> map的用法</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//通过:= 创建</span>
  m1 <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;陈霖&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;24&quot;</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
  <span class="token comment">//遍历</span>
  <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token operator">:=</span> <span class="token keyword">range</span> m1<span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token comment">//测试kv是否存在，存在ok=true,否则ok=false</span>
  <span class="token keyword">if</span> name<span class="token punctuation">,</span>ok <span class="token operator">:=</span> m1 m1<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ok<span class="token punctuation">{</span>  <span class="token punctuation">}</span>
  <span class="token comment">//通过make创建</span>
  m2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
  m2<span class="token punctuation">[</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;shantou&quot;</span>
  <span class="token comment">//修改</span>
  m2<span class="token punctuation">[</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;gaungzhou&quot;</span>
  <span class="token comment">//删除</span>
  <span class="token function">delete</span><span class="token punctuation">(</span>m2<span class="token punctuation">,</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">//注意 var创建的是一个为空指针的map，无法操作</span>
  <span class="token keyword">var</span> m3 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="map的底层结构"><a href="#map的底层结构" class="header-anchor">#</a> map的底层结构</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    count <span class="token builtin">int</span> <span class="token comment">//记录当前map存储的key数量，可以通过builtin包中的len函数返回map的长度</span>
    flags <span class="token builtin">uint8</span><span class="token comment">//迭代map或者对map进行写操作的时候，会记录该标志位，用于一些并发场景的检查校验</span>
    B <span class="token builtin">uint8</span> <span class="token comment">//len(buckets) == 2^B</span>
    noverflow <span class="token builtin">uint64</span> <span class="token comment">//overflow的bucket近似数量</span>
    hash0 uin32<span class="token comment">//能为hash函数的结果引入随机性</span>
    buckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">//指向具体的buckets数组</span>
    oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">//当map扩容时，指向旧的buckets数组</span>
    necacuate <span class="token builtin">uintptr</span><span class="token comment">//用于表示扩容搬迁进度</span>
    extras <span class="token operator">*</span>mapextra <span class="token comment">//当map的key和value都不是指针，go为了避免GC扫描整个hmap，会将bmap的overflow字段引动到extra</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> mapextra <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    overflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap
    oldoverflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap
    nextOverflow <span class="token operator">*</span>bmap
<span class="token punctuation">}</span>

<span class="token comment">//buckets即bmap的数组，这是在源码包中的代码</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>
<span class="token punctuation">}</span>

<span class="token comment">//在源码包中的代码会经过反射编译为以下新的结构体</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tophash <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin">uint8</span> <span class="token comment">//存储哈希值的高8位</span>
    keys <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>keytype
    values <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>valuetype
    pad <span class="token builtin">uintptr</span>
    overflow <span class="token builtin">uintptr</span> <span class="token comment">//溢出bucket的地址</span>
<span class="token punctuation">}</span>



</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f281ea45dfc4969a3ebba2239abb2ed~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="img"></p> <p>go的map中它的底层是hmap，hmap中维护着若干个bucket数组，bucket数组中每个元素都是bmap结构。</p> <p><img src="https://kevinwu0904-blog-images.oss-cn-shanghai.aliyuncs.com/blogs-golang-map/20210719113331.png" alt="map整体结构"></p> <p>bmap可最多防止8个kv,为了空间利用率key和value分别存放，操作桶大小的部分会创建新的桶并通过overflow串联起来，顶层的tophash存放着每个key hash值的高8位，用于插入时的快速比较</p> <h3 id="map的创建"><a href="#map的创建" class="header-anchor">#</a> map的创建</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> 
	m2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 创建map支持传递一个参数，表示初始大小</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m1<span class="token punctuation">,</span> m2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="map底层创建有三种实现"><a href="#map底层创建有三种实现" class="header-anchor">#</a> map底层创建有三种实现：</h4> <ol><li><code>makemap_small</code>:当map编译期确定初始化长度不大于bucketCnt(即8)，只创建hmap，不初始化buckets</li> <li><code>makemap64</code>:当make函数传递的长度参数类型是int64的时候，调用该函数底层仍然是复用<code>makemap</code>,实则就是将int64转为int</li> <li><code>makemap</code>:初始化hash0加入随机性，计算对数B，并初始化buckets</li></ol> <h3 id="map的访问"><a href="#map的访问" class="header-anchor">#</a> map的访问</h3> <p>即通过给定的key在map中寻找对应的value，大致步骤如下：</p> <ol><li>以64位操作系统为例，原始的key通过Hash函数映射成64位二进制</li> <li>低B位对应bmap的位置，从[]bmap中找到对应的bmap</li> <li>高8位对应改key的tophash，从步骤二所对应的bmap开始检索，首先会比较bmap顶层的tophash与原始key的tophash是否相同，若不同则直接跳过比较下一个；若相同则进行下一步比较key是否相同。</li> <li>若当前的bmap中比较完，没有匹配到目标key，且overflow不为空，则继续从overflow指向的下一bmap中继续比较</li></ol> <h3 id="get拿取数据"><a href="#get拿取数据" class="header-anchor">#</a> GET拿取数据</h3> <p>假设当前B=4，即桶的数量为2^B=16个，要从map中获取key对应的value,有以下几个步骤：</p> <p>map汇编后看出map的访问对应到底层代码主要是<code>runtime.mapaccess1</code>和<code>runtime.mapaccess2</code>两个方法，mapraccess2相比mapraccess1多了一个bool返回值，表示该key是否存在，其他逻辑基本一致。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapaccess1</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span>h <span class="token operator">*</span>hmap<span class="token punctuation">,</span>key unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">{</span>
    <span class="token keyword">if</span> raceenabled <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		callerpc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		pc <span class="token operator">:=</span> <span class="token function">funcPC</span><span class="token punctuation">(</span>mapaccess1<span class="token punctuation">)</span>
		<span class="token function">racereadpc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> callerpc<span class="token punctuation">,</span> pc<span class="token punctuation">)</span>
		<span class="token function">raceReadObjectPC</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>key<span class="token punctuation">,</span> key<span class="token punctuation">,</span> callerpc<span class="token punctuation">,</span> pc<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> msanenabled <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">msanread</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> t<span class="token punctuation">.</span>key<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">hashMightPanic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// see issue 23734</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// map不允许并发读写，会触发该panic。这里是通过flags的标记位来判断是否正在进行写操作。</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map read and map write&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">hasher</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
	m <span class="token operator">:=</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token comment">// m即后B位，用于定位[]bmap中对应的bmap。</span>
	b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 定位到具体的bmap。</span>
	<span class="token keyword">if</span> c <span class="token operator">:=</span> h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// There used to be half as many buckets; mask down one more power of two.</span>
			m <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>
		oldb <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">(</span>hash<span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">evacuated</span><span class="token punctuation">(</span>oldb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			b <span class="token operator">=</span> oldb
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	top <span class="token operator">:=</span> <span class="token function">tophash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token comment">// tophash即首8位，用于快速比较。</span>
bucketloop<span class="token punctuation">:</span>
	<span class="token comment">// 遍历迭代bmap和它的overflow bmap。</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> b <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token comment">// 首先比较tophash是否相同，不相同会直接continue。</span>
			<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> top <span class="token punctuation">{</span> 
				<span class="token keyword">if</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> emptyRest <span class="token punctuation">{</span>
					<span class="token keyword">break</span> bucketloop
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>keysize<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">indirectkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// tophash相同的情况下，会比较key的值是否相同。若相同，则说明已经定位到该key，返回结果。</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>keysize<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>elemsize<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">indirectelem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					e <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> e
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>如果key是string，int32/uint32，int64/uint64在go中会被汇编成不同的函数，大致逻辑与mapaccess1逻辑一致，只是对key进行处理的部分不一样</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapaccess1_fast32</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key <span class="token builtin">uint32</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer
<span class="token keyword">func</span> <span class="token function">mapaccess2_fast32</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key <span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">mapaccess1_fast64</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key <span class="token builtin">uint64</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer
<span class="token keyword">func</span> <span class="token function">mapaccess2_fast64</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> key <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">mapaccess1_faststr</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> ky <span class="token builtin">string</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer
<span class="token keyword">func</span> <span class="token function">mapaccess2_faststr</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> ky <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="map的赋值"><a href="#map的赋值" class="header-anchor">#</a> map的赋值</h3> <p><code>在不考虑扩容的情况下，map的赋值和map的访问逻辑基本一致，首先遵循map访问的方式通过后B位确定bmap,通过前8位确定tophash。当map中不存在该key，会记录bmap中第一个空闲的tophash，并插入该key，但map中存在该key，则更新该key的value</code></p> <p>通过汇编后的代码调用可以看出map赋值对应的底层实现对应<code>runtime.mapassign</code></p> <h3 id="map的扩容"><a href="#map的扩容" class="header-anchor">#</a> map的扩容</h3> <p>map扩容的目的在于减少Hash冲突，防止算法复杂度退化，保持hash算法O(1)的时间复杂度</p> <p>map的扩容是渐进式的，即整个扩容过程拆散在每一次写操作里面，这样做的好处就是保证每一个map的读写操作时间复杂度都是稳定的。</p> <h4 id="触发扩容的时机有两个"><a href="#触发扩容的时机有两个" class="header-anchor">#</a> 触发扩容的时机有两个：</h4> <ol><li><p>map的负载因子（长度与容量的比例）超过阈值（6.5），此时map认为无法承担更多的key，需要两倍扩容。</p></li> <li><p>溢出桶的数量过多</p> <p>当B &lt; 15时，如果overflow的bucket数量超过了2^B</p> <p>当B &gt; 15时，如果overflow的bucket数量超过了2^15</p> <p>map存在局部bmap含有过多的overflow的情况，此时map会认为局部bmap可以进行tophash密集排序，让overflow的数量更少，这种扩容实际上是一种整理，把后置位的数据整理到前面，这种情况下元素会发生重排但是不会换桶，即相同容量扩容</p></li></ol> <h4 id="扩容的细节"><a href="#扩容的细节" class="header-anchor">#</a> 扩容的细节</h4> <ol><li>hmap结构中有一个oldbuckets，扩容刚发生时，先将老数据存到这个里面</li> <li>每次对map进行增删改查的时候，会触发从oldbucket中迁移到bucket的操作，非一次性，分为多次</li> <li>在扩容没有完全迁移完成之前，每次get或者put遍历数据时，都会先遍历oldbuckets然后再遍历buckets</li></ol> <h3 id="map的删除"><a href="#map的删除" class="header-anchor">#</a> map的删除</h3> <p>map的删除与访问基本逻辑一致，遍历bmap与overflow寻找目标key，如果可以找到则清空tophash并删除key/value释放内存。</p> <h3 id="map的迭代"><a href="#map的迭代" class="header-anchor">#</a> map的迭代</h3> <p>由于map存在渐进式扩容，因此map的迭代并不像想象中的那么直接，而需要考虑搬迁过程中的迭代，map在搬迁过程中会通过nevacuate来记录搬迁进度，因此在迭代过程中需要同时考虑遍历旧的bmap和新的bmap</p> <p>从编译结果中，我们可以看出map的迭代底层对应的是<code>runtime.mapiterinit</code>和<code>runtime.mapiternext</code>：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapiterinit</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">,</span> h <span class="token operator">*</span>hmap<span class="token punctuation">,</span> it <span class="token operator">*</span>hiter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> raceenabled <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		callerpc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">racereadpc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> callerpc<span class="token punctuation">,</span> <span class="token function">funcPC</span><span class="token punctuation">(</span>mapiterinit<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>hiter<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">/</span>sys<span class="token punctuation">.</span>PtrSize <span class="token operator">!=</span> <span class="token number">12</span> <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;hash_iter size incorrect&quot;</span><span class="token punctuation">)</span> <span class="token comment">// see cmd/compile/internal/gc/reflect.go</span>
	<span class="token punctuation">}</span>
	it<span class="token punctuation">.</span>t <span class="token operator">=</span> t
	it<span class="token punctuation">.</span>h <span class="token operator">=</span> h
	<span class="token comment">// grab snapshot of bucket state</span>
	it<span class="token punctuation">.</span>B <span class="token operator">=</span> h<span class="token punctuation">.</span>B
	it<span class="token punctuation">.</span>buckets <span class="token operator">=</span> h<span class="token punctuation">.</span>buckets
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>ptrdata <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">.</span><span class="token function">createOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		it<span class="token punctuation">.</span>overflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>overflow
		it<span class="token punctuation">.</span>oldoverflow <span class="token operator">=</span> h<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>oldoverflow
	<span class="token punctuation">}</span>
	<span class="token comment">// decide where to start</span>
	<span class="token comment">// 可以看出，map的迭代器会随机选择一个开始的bucket位置和开始的offset。</span>
	r <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>B <span class="token operator">&gt;</span> <span class="token number">31</span><span class="token operator">-</span>bucketCntBits <span class="token punctuation">{</span>
		r <span class="token operator">+=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span>
	<span class="token punctuation">}</span>
	it<span class="token punctuation">.</span>startBucket <span class="token operator">=</span> r <span class="token operator">&amp;</span> <span class="token function">bucketMask</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
	it<span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token function">uint8</span><span class="token punctuation">(</span>r <span class="token operator">&gt;&gt;</span> h<span class="token punctuation">.</span>B <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// iterator state</span>
	it<span class="token punctuation">.</span>bucket <span class="token operator">=</span> it<span class="token punctuation">.</span>startBucket <span class="token comment">// 记录随机的开始位置。</span>
	<span class="token keyword">if</span> old <span class="token operator">:=</span> h<span class="token punctuation">.</span>flags<span class="token punctuation">;</span> old<span class="token operator">&amp;</span><span class="token punctuation">(</span>iterator<span class="token operator">|</span>oldIterator<span class="token punctuation">)</span> <span class="token operator">!=</span> iterator<span class="token operator">|</span>oldIterator <span class="token punctuation">{</span>
		atomic<span class="token punctuation">.</span><span class="token function">Or8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> iterator<span class="token operator">|</span>oldIterator<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">mapiternext</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mapiternext</span><span class="token punctuation">(</span>it <span class="token operator">*</span>hiter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	h <span class="token operator">:=</span> it<span class="token punctuation">.</span>h
	<span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>
		callerpc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">racereadpc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> callerpc<span class="token punctuation">,</span> <span class="token function">funcPC</span><span class="token punctuation">(</span>mapiternext<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> h<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>hashWriting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;concurrent map iteration and map write&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	t <span class="token operator">:=</span> it<span class="token punctuation">.</span>t
	bucket <span class="token operator">:=</span> it<span class="token punctuation">.</span>bucket
	b <span class="token operator">:=</span> it<span class="token punctuation">.</span>bptr
	i <span class="token operator">:=</span> it<span class="token punctuation">.</span>i
	checkBucket <span class="token operator">:=</span> it<span class="token punctuation">.</span>checkBucket
next<span class="token punctuation">:</span>
	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> bucket <span class="token operator">==</span> it<span class="token punctuation">.</span>startBucket <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>wrapped <span class="token punctuation">{</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token boolean">nil</span>
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 判断是否正处于扩容搬迁中,对于正在搬迁过程中仍未完成搬迁的bucket,迭代过程中需要考虑进入旧的bucket里面</span>
		<span class="token keyword">if</span> h<span class="token punctuation">.</span><span class="token function">growing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>B <span class="token operator">==</span> h<span class="token punctuation">.</span>B <span class="token punctuation">{</span>
			oldbucket <span class="token operator">:=</span> bucket <span class="token operator">&amp;</span> it<span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">oldbucketmask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>oldbuckets<span class="token punctuation">,</span> oldbucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">evacuated</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				checkBucket <span class="token operator">=</span> bucket
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> bucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				checkBucket <span class="token operator">=</span> noCheck
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>buckets<span class="token punctuation">,</span> bucket<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			checkBucket <span class="token operator">=</span> noCheck
		<span class="token punctuation">}</span>
		bucket<span class="token operator">++</span>
		<span class="token keyword">if</span> bucket <span class="token operator">==</span> <span class="token function">bucketShift</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			bucket <span class="token operator">=</span> <span class="token number">0</span>
			it<span class="token punctuation">.</span>wrapped <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		i <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bucketCnt<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		offi <span class="token operator">:=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> it<span class="token punctuation">.</span>offset<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bucketCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">==</span> evacuatedEmpty <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		k <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span>offi<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>keysize<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">indirectkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			k <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		e <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> dataOffset<span class="token operator">+</span>bucketCnt<span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>keysize<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span>offi<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>elemsize<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> checkBucket <span class="token operator">!=</span> noCheck <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">sameSizeGrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">reflexivekey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				hash <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">hasher</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hash0<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> hash<span class="token operator">&amp;</span><span class="token function">bucketMask</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token operator">!=</span> checkBucket <span class="token punctuation">{</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> checkBucket<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>B<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">!=</span> evacuatedX <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>tophash<span class="token punctuation">[</span>offi<span class="token punctuation">]</span> <span class="token operator">!=</span> evacuatedY<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">reflexivekey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> k
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">indirectelem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				e <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> e
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			rk<span class="token punctuation">,</span> re <span class="token operator">:=</span> <span class="token function">mapaccessK</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> h<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
			<span class="token keyword">if</span> rk <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span> <span class="token comment">// key has been deleted</span>
			<span class="token punctuation">}</span>
			it<span class="token punctuation">.</span>key <span class="token operator">=</span> rk
			it<span class="token punctuation">.</span>elem <span class="token operator">=</span> re
		<span class="token punctuation">}</span>
		it<span class="token punctuation">.</span>bucket <span class="token operator">=</span> bucket
		<span class="token keyword">if</span> it<span class="token punctuation">.</span>bptr <span class="token operator">!=</span> b <span class="token punctuation">{</span> <span class="token comment">// avoid unnecessary write barrier; see issue 14921</span>
			it<span class="token punctuation">.</span>bptr <span class="token operator">=</span> b
		<span class="token punctuation">}</span>
		it<span class="token punctuation">.</span>i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
		it<span class="token punctuation">.</span>checkBucket <span class="token operator">=</span> checkBucket
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	b <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">overflow</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	i <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">goto</span> next
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>map的迭代顺序完全是随机的，并且map在迭代过程中会根据搬迁进度来判断是否要兼顾旧的bucket</p> <h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <ol><li><p>对map数据进行操作时不可取地址，因为map会随着元素数量的增长而重新分配更大的内存空间，会导致之前拿到的地址改变，导致地址无效</p></li> <li><p>map时线程不安全的，在工作中当我们涉及一个map进行并发读写时，一般采用的做法是采用goland中自带的mutex</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Resource <span class="token keyword">struct</span><span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span>RWMutex
    m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> main<span class="token punctuation">{</span>
    r <span class="token operator">:=</span> Resource<span class="token punctuation">{</span>m <span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> j<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span>j <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            r<span class="token punctuation">.</span>m<span class="token punctuation">[</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;resource_%d&quot;</span>，j<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> j
            r<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span>j <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>m<span class="token punctuation">[</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;resource_%d&quot;</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            r<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li></ol> <h2 id="sync-map"><a href="#sync-map" class="header-anchor">#</a> sync.map</h2> <p>Go内建的map是不支持并发写操作的，原因是map写操作不是并发安全的，但超时多个Goroutine操作同一个map时，会产生报错：<code>fatal error: concurrent map writes</code></p> <p>​		因此官方引入了sync.map来满足并发编程的需求，一般情况下解决并发map的思路就是加一把大锁，或者把一个map分成若干的小map，对key进行hash，只操作相应的小map。前者锁粒度比较大，影响效率，后者实现起来比较复制比较容易出错，而sync.map对map的读写，不需要加锁，并且通过空间换时间的方式，使用read和dirty两个map来进行读写分离，降低锁时间来提高效率。</p> <h3 id="如何使用"><a href="#如何使用" class="header-anchor">#</a> 如何使用</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span><span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> m sync<span class="token punctuation">.</span><span class="token keyword">map</span>
    <span class="token comment">//写入</span>
    m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//读取</span>
    age<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//遍历</span>
    m<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token builtin">bool</span><span class="token punctuation">{</span>
        name <span class="token operator">:=</span> key<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
        age <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   	<span class="token comment">//删除</span>
    m<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
   	<span class="token comment">//读取不存在则写入</span>
    m<span class="token punctuation">.</span><span class="token function">LoadOrStore</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="map数据结构"><a href="#map数据结构" class="header-anchor">#</a> Map数据结构</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Map <span class="token keyword">struct</span><span class="token punctuation">{</span>
    mu Mutex
    read atomic<span class="token punctuation">.</span>Value <span class="token comment">//readOnly</span>
    dirty <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">*</span>entry
    misses <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token comment">// readOnly is an immutable struct stored atomically in the Map.read field.</span>
<span class="token keyword">type</span> readOnly <span class="token keyword">struct</span><span class="token punctuation">{</span>
    m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">*</span>entry
    <span class="token comment">// true if the dirty map contains some key not in m</span>
    amended <span class="token builtin">bool</span>	
<span class="token punctuation">}</span>

<span class="token keyword">type</span> entry <span class="token keyword">struct</span><span class="token punctuation">{</span>
    <span class="token comment">// *interface{}</span>
    p unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><ul><li>mu：互斥锁，用于保护read和dirty</li> <li>read：只读数据，支持并发读取（atomic.Value类型）。如果涉及到更新操作，则只需要加锁保证数据安全，read实际存储的是readOnly结构体，内存也是一个原生的map，amended属于用于标记read和dirty的数据是否一致</li> <li>dirty：读写数据，是一个原生map，也是非线性安全。操作dirty需要加锁来保证数据安全</li> <li>misses：统计有多少次读取read没有命中，每次read中读取失败后，misses的计数值都会加1</li> <li>在read和dirty中，都有涉及到entry结构体，其中包含一个指针，用于指向用户存储的元素（key）所指向的value值，read和dirty各自维护一套key，key指向的都是同一个value，也就是说，只要修改了这个entry，对read和dirty都是可见的。</li></ul></blockquote> <p>这个entry指针的状态有三种：nil、expunged、正常。</p> <p>​	当 <code>p == nil</code> 时，说明这个键值对已被删除，并且 m.dirty == nil，或 m.dirty[k] 指向该 entry。</p> <p>​	当 <code>p == expunged</code> 时，说明这条键值对已被删除，并且 m.dirty != nil，且 m.dirty 中没有这个 key。</p> <p>​	p 指向一个正常的值，表示实际 <code>interface{}</code> 的地址，并且被记录在 m.read.m[key] 中。如果这时 m.dirty 不为 nil，那么它也被记录在 m.dirty[key] 中。两者实际上指向的是同一个值。</p> <h3 id="查找过程"><a href="#查找过程" class="header-anchor">#</a> 查找过程：</h3> <p>当我们从sync.Map类型中读取数据时，其会先查看read中是否包含所需的元素</p> <ul><li>若有，则通过atomic原子操作读取数据并返回</li> <li>若无，这会判断read.readOnly中的amended属性，它会告诉dirty是否包含read.readOnly.m中没有的数据；若amended为true就会到dirty中查找数据</li></ul> <p>sync.Map的读性能之所以如此之高的原因就在于存在read这一巧妙的设计，作为一个缓存层，提供了快路劲的查找。同时结合amended属性，解决了每次读取都设计锁的问题，实现读这一个使用场景的高性能。</p> <h4 id="load"><a href="#load" class="header-anchor">#</a> load:</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    read<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">)</span>
    e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// 如果没在read中找到,并且amended为true,即dirty中存在read中没有的key</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
        m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//dirty map不是线程安全的,所以需要加上互斥锁</span>
        <span class="token comment">//double check,避免在上锁的过程中dirty map提升为read map。</span>
        read<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">)</span>
        e<span class="token punctuation">,</span> ok <span class="token operator">=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token comment">//仍然没有在read中找到这个key,并且amended为true</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">&amp;&amp;</span> read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
            e<span class="token punctuation">,</span> ok <span class="token operator">=</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">//从dirty中找</span>
            <span class="token comment">//不管dirty中有没有找到,都要&quot;记一笔&quot;,因为在dirty提升为read之前,都会进入这条路径</span>
            m<span class="token punctuation">.</span><span class="token function">missLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span> <span class="token comment">//如果没找到,返回空,false</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">missLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>misses<span class="token operator">++</span>
    <span class="token keyword">if</span> m<span class="token punctuation">.</span>misses <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// dirty map 晋升</span>
    m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">{</span>m<span class="token punctuation">:</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">}</span><span class="token punctuation">)</span>
    m<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">nil</span>
    m<span class="token punctuation">.</span>misses <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">//entry 的 load </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>entry<span class="token punctuation">)</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    p <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadPointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token punctuation">.</span>p<span class="token punctuation">)</span>
    <span class="token keyword">if</span> p <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> p <span class="token operator">==</span> expunged <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="写入过程"><a href="#写入过程" class="header-anchor">#</a> 写入过程：</h3> <p>即sync.Map的Store方法，该方法的作用是新增或者更新一个元素</p> <h4 id="stroe"><a href="#stroe" class="header-anchor">#</a> stroe:</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Store sets the value for a key.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">Store</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果read map中存在该key则尝试直接更改(由于修改的是entry内部的pointer,因此dirty map也可见)</span>
    read<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">)</span>
    <span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">tryStore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
   	 <span class="token punctuation">}</span>
    m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    read<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">)</span>
    <span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> read<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">if</span> e<span class="token punctuation">.</span><span class="token function">unexpungeLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果read map中存在该key,但p==expunged,则说明m.dirty!= nil并且m.dirty中不存在该key值，此时:</span>
            <span class="token comment">//a. 将 p 的状态由 expunged  更改为 nil ; </span>
            <span class="token comment">//b. dirty map 插入 key;</span>
            m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> e
        <span class="token punctuation">}</span>
        <span class="token comment">//更新entry.p = value(read map和dirty map指向同一个entry)</span>
        e<span class="token punctuation">.</span><span class="token function">storeLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token comment">//如果read map中不存在该key但dirty map中存在该key,直接写入更新 entry(read map中仍然没有这个key)</span>
        e<span class="token punctuation">.</span><span class="token function">storeLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果read map和dirty map中都不存在该key,则：</span>
        <span class="token comment">//a. 如果dirty map为空,则需要创建dirty map,并从read map中拷贝未删除的元素到新创建的dirty map</span>
        <span class="token comment">//b. 更新amended字段,标识dirty map中存在read map中没有的key</span>
        <span class="token comment">//c. 将kv写入dirty map中,read不变</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>read<span class="token punctuation">.</span>amended <span class="token punctuation">{</span>
            <span class="token comment">// 到这里就意味着，当前的 key 是第一次被加到 dirty map 中。</span>
            <span class="token comment">// store 之前先判断一下 dirty map 是否为空，如果为空，就把 read map 浅拷贝一次。</span>
            m<span class="token punctuation">.</span><span class="token function">dirtyLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            m<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>readOnly<span class="token punctuation">{</span>m<span class="token punctuation">:</span> read<span class="token punctuation">.</span>m<span class="token punctuation">,</span> amended<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 写入新 key，在 dirty 中存储 value</span>
        m<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newEntry</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// unexpungeLocked 函数确保了 entry 没有被标记成已被清除</span>
<span class="token comment">// 如果 entry 先前被清除过了，那么在 mutex 解锁之前，它一定要被加入到 dirty map 中</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>entry<span class="token punctuation">)</span> <span class="token function">unexpungeLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>wasExpunged <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapPointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token punctuation">.</span>p<span class="token punctuation">,</span> expunged<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h4 id="流程"><a href="#流程" class="header-anchor">#</a> 流程：</h4> <blockquote><ol><li>调用 <code>Load</code> 方法检查 <code>m.read</code> 中是否存在这个元素。若存在，且没有被标记为删除状态，则尝试存储</li> <li>若该元素不存在或已经被标记为删除状态，直接调用了 <code>Lock</code> 方法<strong>上互斥锁</strong>，保证数据安全。
<ul><li>如果read中存在该key，但已经被标记为已删除(expunged)，则说明 dirty 不等于nil(dirty中肯定不存在该元素)，将元素状态从已删除(expunged)更改为nil,将元素插入dirty中</li> <li>若发现read中不存在该元素，但dirty中存在该元素，则直接写入更新entry的指向</li> <li>若发现 read 和 dirty 都不存在该元素，则从 read 中复制未被标记删除的数据，并向 dirty 中插入该元素，赋予元素值 entry 的指向</li></ul></li></ol></blockquote> <p>为什么写入性能差，原因：</p> <ol><li>写入时一定要经过read，多了一层查询，后续还要查询数据情况和状态，性能开销比较大</li> <li>第三个逻辑处理分支，当初始化或者dirty被提升后，会从read中复制全量的数据，若read中数据量大，则会影响性能</li></ol> <h3 id="删除过程"><a href="#删除过程" class="header-anchor">#</a> 删除过程：</h3> <ol><li>删除依旧得先到read检查元素是否存在，若存在则调用delete标记为expunged（删除状态），非常高效。可以明确read中的元素被删除，性能是非常好的。</li> <li>若不存在，根据amended的值是否为true，判断read与dirty是否不一致，不一致则需要走dirty流程，上互斥锁。</li> <li>调用delete方法从dirty中标记该元素被删除</li></ol> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>entry<span class="token punctuation">)</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">{</span>
  p <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadPointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token punctuation">.</span>p<span class="token punctuation">)</span>
  <span class="token keyword">if</span> p <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> p <span class="token operator">==</span> expunged <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapPointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token punctuation">.</span>p<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>delete方法是将entry.p置为nil,并且标记为expunged（删除状态），而不是真真正正的删除</p> <h3 id="分段锁实现"><a href="#分段锁实现" class="header-anchor">#</a> 分段锁实现</h3> <h2 id="map实现set"><a href="#map实现set" class="header-anchor">#</a> map实现set</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Set <span class="token keyword">struct</span><span class="token punctuation">{</span>
    <span class="token keyword">map</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    lock sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>set <span class="token operator">*</span>Set<span class="token punctuation">)</span><span class="token function">add</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">{</span>
    set<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span>ok <span class="token operator">:=</span> set<span class="token punctuation">.</span><span class="token keyword">map</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>ok<span class="token punctuation">{</span><span class="token comment">//存在</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token comment">//不存在</span>
        set<span class="token punctuation">.</span><span class="token keyword">map</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> set<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>set <span class="token operator">*</span>Set<span class="token punctuation">)</span><span class="token function">isHas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">bool</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span>ok <span class="token operator">:=</span> set<span class="token punctuation">.</span><span class="token keyword">map</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">!</span>ok<span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>set <span class="token operator">*</span>Set<span class="token punctuation">)</span><span class="token function">del</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token builtin">bool</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span>ok <span class="token operator">:=</span> set<span class="token punctuation">.</span><span class="token keyword">map</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token operator">!</span>ok<span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">delete</span><span class="token punctuation">(</span>set<span class="token punctuation">.</span><span class="token keyword">map</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>∑</p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">March 15, 2023 13:42</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: 807686672@qq.com" class="contributor">
          clsld
        </span> <!----></span></div></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><!----><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close" aria-label="Close" class="pswp__button pswp__button--close"></button> <button title="Share" aria-label="Share" class="pswp__button pswp__button--share"></button> <button title="Switch to full screen" aria-label="Switch to full screen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" aria-label="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Prev (Arrow Left)" aria-label="Prev (Arrow Left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (Arrow Right)" aria-label="Next (Arrow Right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/assets/js/app.21284b8f.js" defer></script><script src="/assets/js/vendors~layout-Layout.cb79b8cd.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.7be66c78.js" defer></script><script src="/assets/js/page-map.41dbe3e8.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout.9ce9a2be.js" defer></script>
  </body>
</html>
