<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>缓存的问题以及双写不一致分析 | clsld &#39;s codebook</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="clsld &#39;s 的个人博客">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/assets/css/0.styles.cbe5bae5.css" as="style"><link rel="preload" href="/assets/js/app.ffa732a7.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Layout.2f4b1f44.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.7be66c78.js" as="script"><link rel="preload" href="/assets/js/page-缓存的问题以及双写不一致分析.8a71b3cf.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout.9ce9a2be.js" as="script"><link rel="prefetch" href="/assets/js/63.80a16ac4.js"><link rel="prefetch" href="/assets/js/64.858d7f75.js"><link rel="prefetch" href="/assets/js/layout-Blog.68b41fe1.js"><link rel="prefetch" href="/assets/js/layout-Layout.f3e9cb51.js"><link rel="prefetch" href="/assets/js/layout-NotFound.4f4e0f56.js"><link rel="prefetch" href="/assets/js/layout-Slide.9bc3a124.js"><link rel="prefetch" href="/assets/js/page--24251f30.8f55252e.js"><link rel="prefetch" href="/assets/js/page--779ab921.20a0ad56.js"><link rel="prefetch" href="/assets/js/page-CSRF与跨域.d6db0b53.js"><link rel="prefetch" href="/assets/js/page-Flamingo年终总结.7a303d28.js"><link rel="prefetch" href="/assets/js/page-GiteePage自动更新脚本.b4a44446.js"><link rel="prefetch" href="/assets/js/page-GoRuntime.276975e0.js"><link rel="prefetch" href="/assets/js/page-Hbase.608140e9.js"><link rel="prefetch" href="/assets/js/page-LSM.c18bec72.js"><link rel="prefetch" href="/assets/js/page-MapReduce.7c13019e.js"><link rel="prefetch" href="/assets/js/page-Mysql复习.7309d86e.js"><link rel="prefetch" href="/assets/js/page-Redis复习.c6449e5c.js"><link rel="prefetch" href="/assets/js/page-Tidb.3ca6f9e1.js"><link rel="prefetch" href="/assets/js/page-Todo.fb536dce.js"><link rel="prefetch" href="/assets/js/page-atomic.b4a6caf0.js"><link rel="prefetch" href="/assets/js/page-centos7下安装docker.a4aca641.js"><link rel="prefetch" href="/assets/js/page-centos下mysql的安装和配置远程.579dd0e7.js"><link rel="prefetch" href="/assets/js/page-channel.0032ef7d.js"><link rel="prefetch" href="/assets/js/page-context.b2642f51.js"><link rel="prefetch" href="/assets/js/page-cpuload比较高，怎么排查？.87542f37.js"><link rel="prefetch" href="/assets/js/page-docker的jar包快速部署运行.8039b630.js"><link rel="prefetch" href="/assets/js/page-goland基础.8ac60c46.js"><link rel="prefetch" href="/assets/js/page-gotest.062e9920.js"><link rel="prefetch" href="/assets/js/page-go服务限流熔断.d4d8b383.js"><link rel="prefetch" href="/assets/js/page-go简单优化笔记.25b75b00.js"><link rel="prefetch" href="/assets/js/page-istio学习.25802d47.js"><link rel="prefetch" href="/assets/js/page-k8sPrometheus组件.d5c57b1b.js"><link rel="prefetch" href="/assets/js/page-kafka相关问题.c5c35159.js"><link rel="prefetch" href="/assets/js/page-map.9650f8f5.js"><link rel="prefetch" href="/assets/js/page-mysql主从复制及主机宕机的解决方法.08bd9770.js"><link rel="prefetch" href="/assets/js/page-mysql执行优化.cd6b1436.js"><link rel="prefetch" href="/assets/js/page-promethues.bc1320d9.js"><link rel="prefetch" href="/assets/js/page-redis的安装和远程连接配置.2fe5c6a6.js"><link rel="prefetch" href="/assets/js/page-select、poll、epoll.bacd3c1c.js"><link rel="prefetch" href="/assets/js/page-slice.c1f371d0.js"><link rel="prefetch" href="/assets/js/page-superGolang.a318bbf7.js"><link rel="prefetch" href="/assets/js/page-superUilts.85545c6c.js"><link rel="prefetch" href="/assets/js/page-superjava.0ead7fff.js"><link rel="prefetch" href="/assets/js/page-syncMutex和symcRWMutex.3693e003.js"><link rel="prefetch" href="/assets/js/page-syncPool.eec2f75a.js"><link rel="prefetch" href="/assets/js/page-什么逃逸分析.bf3aaa2f.js"><link rel="prefetch" href="/assets/js/page-元数据管理.c11a2a55.js"><link rel="prefetch" href="/assets/js/page-剑指offter刷题笔记.3b44b65d.js"><link rel="prefetch" href="/assets/js/page-剧本大纲.404dbc5f.js"><link rel="prefetch" href="/assets/js/page-大量数据处理问题.ce6d6c83.js"><link rel="prefetch" href="/assets/js/page-应聘简历：陈霖（chenlin）.fd77589b.js"><link rel="prefetch" href="/assets/js/page-微服务动态上线下.b1ea42d9.js"><link rel="prefetch" href="/assets/js/page-核心组件.04c60261.js"><link rel="prefetch" href="/assets/js/page-生产中git的使用.d79a3c76.js"><link rel="prefetch" href="/assets/js/page-虚拟内存.60533e30.js"><link rel="prefetch" href="/assets/js/page-计算机与网络.7f61563d.js"><link rel="prefetch" href="/assets/js/page-读写锁和互斥锁的区别.dc1c8165.js"><link rel="prefetch" href="/assets/js/page-零拷贝.51d7f7bf.js"><link rel="prefetch" href="/assets/js/vendors~photo-swipe.3864b813.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cbe5bae5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">clsld 's codebook</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link router-link-active"><i class="iconfont icon-reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont icon-reco-date"></i>
  TimeLine
</a></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/" class="nav-link router-link-active"><i class="iconfont icon-reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont icon-reco-date"></i>
  TimeLine
</a></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable open"><!----> <span class="title">Blogs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/me/" class="sidebar-link">## 应聘简历：陈霖（chenlin）</a></li><li><a href="/blogs/todo/" class="sidebar-link">Todo</a></li><li><a href="/blogs/%E5%89%A7%E6%9C%AC%E5%A4%A7%E7%BA%B2/" class="sidebar-link">剧本大纲</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Goland</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">K 8 S</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable open"><!----> <span class="title">Redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/redis/Redis%E5%A4%8D%E4%B9%A0/" class="sidebar-link">Redis复习</a></li><li><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/" aria-current="page" class="active sidebar-link">缓存的问题以及双写不一致分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存的问题以及双写不一致分析" class="sidebar-link">缓存的问题以及双写不一致分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存模型以及带来的问题" class="sidebar-link heading3">缓存模型以及带来的问题</a></li><li class="sidebar-sub-header"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#布隆过滤器简介" class="sidebar-link heading3">布隆过滤器简介</a></li><li class="sidebar-sub-header"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存击穿" class="sidebar-link heading3">缓存击穿</a></li><li class="sidebar-sub-header"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存雪崩" class="sidebar-link heading3">缓存雪崩</a></li><li class="sidebar-sub-header"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#如何保证redis与数据库的数据一致" class="sidebar-link heading3">如何保证Redis与数据库的数据一致</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">Tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">计划学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">面试</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">缓存的问题以及双写不一致分析</span></h1> <div class="page-info"><!----> <!----><span aria-label="Page views🔢" data-balloon-pos="down" defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 0 0-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/" data-flag-title="缓存的问题以及双写不一致分析" class="leancloud_visitors waline-visitor-count"><span class="leancloud-visitors-count">...</span></span></span><span aria-label="Writing Date📅" data-balloon-pos="down" defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2023-1-31</span></span><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" defaultAuthor="" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 8 min</span> <meta property="timeRequired" content="PT8M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存的问题以及双写不一致分析" class="anchor-link heading2"><div>缓存的问题以及双写不一致分析</div></a></li><li class="anchor"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存模型以及带来的问题" class="anchor-link heading3"><div>缓存模型以及带来的问题</div></a></li><li class="anchor"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#布隆过滤器简介" class="anchor-link heading3"><div>布隆过滤器简介</div></a></li><li class="anchor"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存击穿" class="anchor-link heading3"><div>缓存击穿</div></a></li><li class="anchor"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#缓存雪崩" class="anchor-link heading3"><div>缓存雪崩</div></a></li><li class="anchor"><a href="/blogs/redis/%E7%BC%93%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4%E5%88%86%E6%9E%90/#如何保证redis与数据库的数据一致" class="anchor-link heading3"><div>如何保证Redis与数据库的数据一致</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h2 id="缓存的问题以及双写不一致分析"><a href="#缓存的问题以及双写不一致分析" class="header-anchor">#</a> 缓存的问题以及双写不一致分析</h2> <h3 id="缓存模型以及带来的问题"><a href="#缓存模型以及带来的问题" class="header-anchor">#</a> 缓存模型以及带来的问题</h3> <p>​	<strong>为了保障数据库的高可用和系统的高性能，我们一般会在程序接口与数据库中间在加一层缓存。</strong></p> <p>程序请求流程如下：</p> <p>请求达到redis分为两种情况：</p> <ol><li>如果redis中有对应的数据存在，则直接从redis返回数据。</li> <li>如果redis中对应的数据不存在，那么就会再去DB中去查，将查出来的结果返回给用户同时将结果缓存到redis中。</li></ol> <p>​	那么针对这样的架构设计会带来一些问题，例如<strong>缓存穿透</strong>、<strong>缓存击穿</strong>、<strong>缓存雪崩</strong>，针对这些问题业界也有一些解决方案。</p> <h4 id="缓存穿透"><a href="#缓存穿透" class="header-anchor">#</a> 缓存穿透</h4> <p>​	缓存穿透，即请求在缓存中查不到数据，在数据库中也查不到。可见如果都是这样的查询请求情况会造成数据库大查询压力过大。</p> <h4 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案：</h4> <ol><li>对参数进行合法校验，例如是userid = -1的请求在程序层面直接过滤掉，这可以有效的拦截大部分不合法的请求。</li> <li>将数据库中没有查询到结果的数据也写入到缓存，即key=-1,value=null。这时要注意为了防止redis被无效的key占满，这一类缓存的有效期要设置得短一点。</li> <li>引入布隆过滤器
<ul><li>先将数据库中的key存储在布隆过滤器的bitmap中</li> <li>然后每次客户端查询数据时先访问redis，判断数据在redis中是否存在。</li> <li>如果Redis中不存在该数据，则通过布隆过滤器判断数据是否在数据库中。</li> <li>如果布隆过滤器告诉我们不存在，则直接返回null给客户端即可，避免了查询数据库的操作。</li> <li>如果布隆过滤器告诉我们该Key极有可能存在，那么将查询下推到数据库。</li> <li>要注意布隆过滤器存在一定的误判率，并且布隆过滤器只能加数据，不能减数据。虽然不能完全避免数据穿透的现象，但已经可以将99.99%的穿透查询给屏蔽在Redis层了，极大的降低了底层数据库的压力，减少了资源浪费。</li></ul></li></ol> <h3 id="布隆过滤器简介"><a href="#布隆过滤器简介" class="header-anchor">#</a> 布隆过滤器简介</h3> <h4 id="布隆过滤器实现原理"><a href="#布隆过滤器实现原理" class="header-anchor">#</a> 布隆过滤器实现原理</h4> <ul><li><p>布隆过滤器的核心实现是一个超大的位数组（固定大小的位图bitmap）和一系列的哈希映射函数。</p></li> <li><p>布隆过滤器首先对数组里的位进行初始化，将里面每个位置都置为0。</p></li> <li><p>存入数据</p> <p>​	存入数据时对数据进行hash后将其hash值与bitmap进行映射，如果hash数中有位数为1的话就将bitmap相应位数置1，如果bitmap位数值本身就为1的话就不管。</p></li> <li><p>查询数据</p> <p>​	查询时间hash后的hash数与bitmap进行比较，如果hash数中为1的位置在bitmap中不为1则证明该数不存在。</p></li></ul> <h4 id="布隆过滤器的应用"><a href="#布隆过滤器的应用" class="header-anchor">#</a> 布隆过滤器的应用</h4> <ol><li>数据库防止穿库，Google Bigtable、HBase 和 Cassandra 以及 Postgresql 使用BloomFilter来减少不存在的行或列的磁盘查找。避免代价高昂的磁盘查找会大大提高数据库查询操作的性能。</li> <li>业务场景中判断用户是否阅读过某视频或文章，比如抖音或头条，当然会导致一定的误判，但不会让用户看到重复的内容。</li> <li>缓存宕机、缓存击穿场景，一般判断用户是否在缓存中，如果在则直接返回结果，不在则查询db，如果来一波冷数据，会导致缓存大量击穿，造成雪崩效应，这时候可以用布隆过滤器当缓存的索引，只有在布隆过滤器中，才去查询缓存，如果没查询到，则穿透到db。如果不在布隆器中，则直接返回。</li> <li>WEB拦截器，如果相同请求则拦截，防止重复被攻击。用户第一次请求，将请求参数放入布隆过滤器中，当第二次请求时，先判断请求参数是否被布隆过滤器命中。可以提高缓存命中率。Squid 网页代理缓存服务器在 cache digests 中就使用了布隆过滤器。Google Chrome浏览器使用了布隆过滤器加速安全浏览服务</li> <li>Venti 文档存储系统也采用布隆过滤器来检测先前存储的数据。</li> <li>SPIN 模型检测器也使用布隆过滤器在大规模验证问题时跟踪可达状态空间。</li></ol> <h3 id="缓存击穿"><a href="#缓存击穿" class="header-anchor">#</a> 缓存击穿</h3> <p>​	缓存击穿，即缓存中没有，但是数据库中有。一般是出现在缓存<strong>数据初始化</strong>和<strong>key过期了</strong>的情况。当热点数据key从缓存内失效时，大量访问同时请求这个数据，就会将查询下沉到DB层，此时DB层的负载压力会骤增。</p> <h4 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案：</h4> <ol><li><p>设置热点缓存用不过期或者延长过期时间。这时要注意在value当中包含一个逻辑上的过期时间，然后另起一个线程定期重建这些缓存。</p></li> <li><p>在查询DB的时候要防止并发，设置一个互斥锁，只让一个请求通过，只有一个请求去数据库中拉取数据，取完数据后将数据缓存到redis，避免其他大量请求同时穿过Redis访问底层数据库。</p> <p>在使用互斥锁时要避免出现死锁或者锁过期的情况：</p> <ul><li>lua脚本或事务将获取锁和设置锁过期时间作为一个原子性操作，以避免出现某个客户端获取锁之后宕机导致的死锁问题。</li> <li>另起一个线程监控获取锁的线程的查询状态，快到说过期时间还没查询结束则延长锁的过期时间，避免多次查询锁过期造成计算资源的浪费。</li></ul></li></ol> <h3 id="缓存雪崩"><a href="#缓存雪崩" class="header-anchor">#</a> 缓存雪崩</h3> <p>​	缓存雪崩就是缓存大面积过期，导致请求都被转发到DB。</p> <h4 id="解决方案-3"><a href="#解决方案-3" class="header-anchor">#</a> 解决方案</h4> <ol><li>把缓存的失效时间分散开了，例如在原本同一失效时间的基础上增加一个随机值。</li> <li>延长热点key的过期时间或者设置永不过期</li> <li>对于一定要在固定时间让key失效的场景(例如每日12点准时更新所有最新排名)，可以在固定的失效时间时在接口服务端设置随机延时，将请求的时间打散，让一部分查询先将数据缓存起来</li></ol> <h3 id="如何保证redis与数据库的数据一致"><a href="#如何保证redis与数据库的数据一致" class="header-anchor">#</a> 如何保证Redis与数据库的数据一致</h3> <p>​	当我们对数据进行修改的时候有个问题，到底是<strong>先删缓存</strong>（先删了缓存之后下次访问再从数据库中捞数据然后在写到缓存里面）还是<strong>先写数据库</strong>（先删数据库然后将缓存更新）</p> <h4 id="先删缓存再写数据库"><a href="#先删缓存再写数据库" class="header-anchor">#</a> 先删缓存再写数据库</h4> <h5 id="存在问题"><a href="#存在问题" class="header-anchor">#</a> 存在问题：</h5> <p>​	在高并发场景下，当第一个线程删除了缓存，还没来得及写数据，第二个线程来读取数据，会发现缓存中的数据为空，那就会去读数据库中的数据（读出来的是旧值），读完之后，把读到的结果写入缓存（此时，第一个线程已经把新的值写到缓存里面了），这样缓存中的值就会被覆盖为旧值脏数据。</p> <p>​	产生问题的根本原因：这两个数据修改的操作不是原子性的。</p> <h5 id="解决方案-4"><a href="#解决方案-4" class="header-anchor">#</a> 解决方案：</h5> <ol><li>先操作缓存，但是不删除缓存，将缓存修改为一个特殊值（-999），客户端读缓存时，发现是默认值就休眠一小会再去查redis。（特殊值对业务有侵入；在高并发的场景下，如果同一个数据一瞬间改动很频繁的话，休眠时间可能会多次重复，对性能有影响）</li> <li>延时双删。先删除缓存，然后在写数据库，休眠一段时间，再次删除缓存。（如果数据写操作比较频繁同样会导致存在脏数据的问题）</li></ol> <h5 id="结论"><a href="#结论" class="header-anchor">#</a> 结论：</h5> <p>​	所以在先删除缓存再写数据库这种设计要求写操作不能太频繁，允许高并发的读操作。</p> <h4 id="先写数据库再删缓存"><a href="#先写数据库再删缓存" class="header-anchor">#</a> 先写数据库再删缓存</h4> <h5 id="存在问题-2"><a href="#存在问题-2" class="header-anchor">#</a> 存在问题：</h5> <p>​	如果数据库写完了之后，缓存删除失败，数据就会不一致。</p> <h5 id="解决方案-5"><a href="#解决方案-5" class="header-anchor">#</a> 解决方案：</h5> <ol><li>给缓存设置一个过期时间，当一个缓存过期了，就会去数据库中重读数据（过期时间内缓存就不会更新）</li> <li>引入MQ保证原子操作，有两个消费者，一个操作redis，一个操作MQ,当删除失败就利用mq的重试机制保证最终一致性。（在mq重试机制内缓存还是没有更新）</li> <li>将热点数据缓存设置为不过期，但是在value中写入一个逻辑上的过期时间，另外起一个后台线程扫描这些key，对于逻辑上已过期的缓存，进行删除。</li></ol> <h5 id="结论-2"><a href="#结论-2" class="header-anchor">#</a> 结论：</h5> <p>​	所以先写数据库再删除缓存方案只能保证redis与mysql在一定时间内的最终一致性。</p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">February 4, 2023 16:38</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: 807686672@qq.com" class="contributor">
          clsld
        </span> <!----></span></div></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><!----><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close" aria-label="Close" class="pswp__button pswp__button--close"></button> <button title="Share" aria-label="Share" class="pswp__button pswp__button--share"></button> <button title="Switch to full screen" aria-label="Switch to full screen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" aria-label="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Prev (Arrow Left)" aria-label="Prev (Arrow Left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (Arrow Right)" aria-label="Next (Arrow Right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/assets/js/app.ffa732a7.js" defer></script><script src="/assets/js/vendors~layout-Layout.2f4b1f44.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.7be66c78.js" defer></script><script src="/assets/js/page-缓存的问题以及双写不一致分析.8a71b3cf.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout.9ce9a2be.js" defer></script>
  </body>
</html>
