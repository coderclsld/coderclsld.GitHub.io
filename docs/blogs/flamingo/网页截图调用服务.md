# 网页截图服务服务说明

​	`适配移动端、PC端，适配长截图和窗口大小截图`

## 1  添加截图任务接口

#### 1.1 请求接口

​	`http://10.8.8.222/personSign/ScreenShotsController.php?act=addTask`

#### 1.2 请求参数

​	注意：以下参数Get、Post请求均可。当url字段的参数是get请求时需要进行endecode（这是为了防止url参数中的`&`等符号干扰正常的请求），post请求url则不需要endecode。

| 参数名       | 含义                                                         | 参数示例                                            | 是否必须                                 |
| ------------ | ------------------------------------------------------------ | --------------------------------------------------- | ---------------------------------------- |
| orderid      | 业务传递过来的id（用户自定义)                                | 1                                                   | 是，主要用来防止多个相同的请求被重复消费 |
| business     | 业务类型（用户自定义)                                        | LiuLiuApp                                           | 否，主要用来区分不同业务类型的请求       |
| redrictURL   | 回调地址（用户自定义接口，用于接收任务信息)                  | http://10.8.8.222/personSign/recieveScreenShots.php | 是，任务成功和失败的信息都会返回到该接口 |
| url          | 截图URL网址                                                  | http://baidu.com                                    | 是，请先判断该网站是否可以正常访问       |
| type         | 截图类型：1=>长截图，2=>窗口大小截图，类型：number           | 2                                                   | 否，默认为 2=>窗口大小截图               |
| scrollHeight | 长截图高度限制                                               | 18400                                               | 否，默认为最大截图高度，用来减少截图时间 |
| is_mobile    | 窗口类型：1=>手机端 (844 x 390px），2=>PC端（1920 x 1080px） | 2                                                   | 否，默认为2=>PC端窗口类型                |

​	postman请求示例截图：

![image-20221103153241001](http://down1.testing.guopan.cn/png/20221103/image-1667461178726.png)

#### 1.3 返回参数

| 参数名 | 含义                                     |
| ------ | ---------------------------------------- |
| code   | 状态码，200：加入成功，201：任务重复     |
| msg    | 请求回复信息                             |
| taskid | 任务id(唯一)，用户可保存到自己的数据库中 |
| md5    | 请求参数的MD5加密                        |

​	请求返回示例：

```json
//请求加入成功返回
{
    "code": 200,
    "msg": "入库成功，添加任务队列成功",
    "taskid": "191",
    "md5": "695f1d57471f3d62080645e4a56280d9"
}

//请求已在处理中返回
{
    "code": 201,
    "msg": "该任务已加入任务队列请不要重复添加",
    "taskid": "",
    "md5": ""
}
```

#### 1.4 请求demo

```php
<?php
function send_post($url, $post_data) {
  $postdata = http_build_query($post_data);
  $options = array(
    'http' => array(
      'method' => 'POST',
      'header' => 'Content-type:application/x-www-form-urlencoded',
      'content' => $postdata,
      'timeout' => 15 * 60 // 超时时间（单位:s）
    )
  );
  $context = stream_context_create($options);
  $result = file_get_contents($url, false, $context);
  return $result;
}
$post_data = array(
   "orderid"=>123,//业务自定义订单id
   "business"=>"LiuLiuApp",////业务类型（用户自定义）
   "redrictURL"=>"http://10.8.8.222/personSign/recieveScreenShots.php",//回调地址
   "url"=>"http://baidu.com",//截图URL网址
   "type"=>2,//截图类型
   "scrollHeight"=>18400,//长截图高度限制
   "is_mobile"=>2,//截图窗口类型
);
send_post('http://10.8.8.222/personSign/ScreenShotsController.php?act=addTask', $post_data);
```



## 2、主动获取截图

#### 2.1 请求接口

​	`http://10.8.8.222/personSign/ScreenShotsController.php?act=getImage`

#### 2.2 请求参数

| 参数名 | 含义                                       | 是否必须 |
| ------ | ------------------------------------------ | -------- |
| taskid | 任务id(上一步添加任务获取到的taskid，唯一) | 是       |
| md5    | 参数MD5（上一步添加任务获取到的MD5，唯一） | 是       |

#### 2.3 请求返回

| 参数名   | 含义                                   |
| -------- | -------------------------------------- |
| code     | 状态码，200=>存在截图，201=>不存在截图 |
| msg      | 返回信息                               |
| taskid   | 任务id                                 |
| md5      | 参数MD5                                |
| imageUrl | 图片链接，存在截图才会返回图片链接     |

​	请求成功返回示例截图：

![image-20221103153343980](http://down1.testing.guopan.cn/png/20221103/image-1667461199541.png)

​	请求返回示例:

```json
//存在截图返回
{
    "code": 200,
    "msg": "存在该任务截图",
    "taskid": "193",
    "md5": "695f1d57471f3d62080645e4a56280d9",
    "imageUrl": "http://down1.testing.guopan.cn/f59025c57498db0da72bee8b7371992a.png"
}

//不存在截图返回
{
    "code": 201,
    "msg": "不存在该任务截图",
    "taskid": "193",
    "md5": "695f1d57471f3d62080645e4a56280"
}
```

#### 2.4 请求demo

```php
<?php
$url='http://10.8.8.222/personSign/ScreenShotsController.php?act=getImage';
$taskid="193";
$md5="695f1d57471f3d62080645e4a56280d9";
$url = $url."&".$taskid."&".$md5;
$html = file_get_contents($url);
echo $html;
```



## 3、回调接口规则（get回调）

#### 3.1 回调返回参数

| 回调参数名 | 含义                                        |
| ---------- | ------------------------------------------- |
| code       | 状态码，统一为200，暂时没有什么作用         |
| rep_code   | 返回任务结果，请看下表                      |
| message    | 返回信息。如果rep_code为200，则返回截图地址 |
| md5        | 任务的参数MD5                               |
| taskid     | 任务id                                      |
| orderid    | 业务id                                      |
| business   | 业务类型                                    |

#### 3.2  rep_code状态码含义

| rep_code 返回码 | 含义                              |
| --------------- | --------------------------------- |
| 200             | 任务执行成功，截图成功            |
| 408             | 任务执行失败，要截图的url不能访问 |
| 400             | 无效请求,如文件没有上传等         |
| 401             | appid或appsecret错误              |
| 404             | 找不到文件                        |
| 500             | 服务器错误                        |

#### 3.3  回调接口demo

```php
<?php
//获取请求参数
$code = isset($_REQUEST['code'])?$_REQUEST['code']:'';
$rep_code = isset($_REQUEST['rep_code'])?$_REQUEST['rep_code']:'';
$message = isset($_REQUEST['message'])?$_REQUEST['message']:'';
$md5 = isset($_REQUEST['md5'])?$_REQUEST['md5']:'';
$taskid = isset($_REQUEST['taskid'])?$_REQUEST['taskid']:'';
$orderid = isset($_REQUEST['orderid'])?$_REQUEST['orderid']:'';
$bussniss = isset($_REQUEST['bussniss'])?$_REQUEST['bussniss']:'';

//拿到参数后判断rep_code值,200为执行成功并成功返回截图url
if ($rep_code == 200){
    //message则为截图
    //入库操作.....
}else{
    //任务执行有问题
    //记录下来，做后续的通知等工作......
}
//打印日志
file_put_contents("/tmp/clsld.log",date('Y-m-d H:i:s').var_export($_REQUEST,true)."\n",FILE_APPEND);
```

#### 3.4 回调接收参数示例截图

![image-20221103153503355](http://down1.testing.guopan.cn/png/20221103/image-1667461227963.png)



